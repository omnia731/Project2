const { Kafka } = require('kafkajs');
const mongoose = require('mongoose');
const dotenv = require('dotenv');
const Event = require('/usr/src/app/dashboard/backend/src/events/eventModel');  // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ Event Ø§Ù„ØµØ­ÙŠØ­

dotenv.config();

console.log("Kafka broker is:", process.env.KAFKA_BROKER);

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Kafka
const kafka = new Kafka({
  clientId: 'test-consumer',
  brokers: [process.env.KAFKA_BROKER || 'kafka:9092'],
});

const consumer = kafka.consumer({ groupId: 'test-group' });
const topics = ['item-arrived', 'item-dispatched', 'low-stock'];

const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

const run = async (retryCount = 0) => {
  try {
    const dbURI = process.env.MONGODB_URI || "mongodb://mongo:27017/dashboardDB";
    console.log("â³ Connecting to MongoDB:", dbURI);
    await mongoose.connect(dbURI, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
      socketTimeoutMS: 45000,  // Ø²ÙŠØ§Ø¯Ø© Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
      connectTimeoutMS: 30000,
      serverSelectionTimeoutMS: 50000,
    });
    console.log("âœ… Connected to MongoDB");

    await delay(5000); // Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Kafka Ø£ØµØ¨Ø­ Ø¬Ø§Ù‡Ø²Ù‹Ø§

    await consumer.connect();
    console.log('âœ… Consumer connected to Kafka');

    for (const topic of topics) {
      await consumer.subscribe({ topic, fromBeginning: true });
      console.log(`ğŸ“Œ Subscribed to topic: ${topic}`);
    }

    await consumer.run({
      eachMessage: async ({ topic, partition, message }) => {
        const event = JSON.parse(message.value.toString());
        console.log(`\nğŸ“¥ Received from [${topic}]`);
        console.log(event);

        const eventData = {};
        for (const key in event) {
          if (event[key] !== undefined && event[key] !== null) {
            eventData[key] = event[key];
          }
        }

        // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù„Ø¯ÙŠÙƒ warehouseId ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Kafka
        if (eventData.warehouseId) {
          try {
            const event = new Event(eventData);
            await event.save();
            console.log('âœ… Event saved to MongoDB');
          } catch (error) {
            console.error('âŒ Error saving event to MongoDB:', error);
          }
        } else {
          console.log("âŒ Missing warehouseId, event skipped");
        }
      },
    });

  } catch (error) {
    console.error('âŒ Error in consumer:', error.message);

    if (retryCount < 5) {
      const delayTime = 5000;
      console.log(`ğŸ” Retrying to connect in ${delayTime / 1000} seconds...`);
      await delay(delayTime);
      run(retryCount + 1);
    } else {
      console.log("âŒ Max retries reached. Exiting.");
    }
  }
};

run().catch(console.error);

